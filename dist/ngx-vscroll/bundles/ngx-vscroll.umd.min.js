!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core")):"function"==typeof define&&define.amd?define("ngx-vscroll",["exports","@angular/core"],e):e((t=t||self)["ngx-vscroll"]={},t.ng.core)}(this,(function(t,e){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function o(t,e){var o="function"==typeof Symbol&&t[Symbol.iterator];if(!o)return t;var r,n,i=o.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(t){n={error:t}}finally{try{r&&!r.done&&(o=i.return)&&o.call(i)}finally{if(n)throw n.error}}return s}function r(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(o(arguments[e]));return t}var n={NONE:0,ADD:1,UPDATE:2,REMOVE:3};n[n.NONE]="NONE",n[n.ADD]="ADD",n[n.UPDATE]="UPDATE",n[n.REMOVE]="REMOVE";var i=function(){function t(){}return t.prototype.getClosestItemIndex=function(t,e){for(var o=e[0].offsetTop,r=0,n=Math.abs(t-o),i=0;i<e.length;i++){var s=Math.abs(t-e[i].offsetTop);s<n&&(n=s,o=e[i].offsetTop,r=i)}return r},t.prototype.getViewportMeta=function(t,e,o){var r=t-e,n=t+e;return r<0&&(r=0),n>=o.length&&(n=o.length),{count:n,startIndex:r}},t.prototype.onItemChange=function(t,e){if(e.length===t.length){var o=this.getItemDifferenceForEqualLength(t,e);if(o.length)return{operation:n.UPDATE,diff:o}}if(e.length>t.length){var r=this.getItemDifference(t,e);if(r.length)return{operation:n.ADD,diff:r}}if(e.length<t.length){var i=this.getItemDifference(e,t);if(i.length)return{operation:n.REMOVE,diff:i}}return{operation:n.NONE}},t.prototype.handleItemChange=function(){},t.prototype.processItemMetaForAdd=function(t,e,o){var r={};e=e.slice(e.length-t.length),t.forEach((function(t,o){r[t.index]=e[o].getBoundingClientRect().height}));var n=t.reduce((function(t,e){return e.index>=o.length?t.above.push(e):t.below.push(e),t}),{above:[],below:[]});n.above.sort((function(t,e){return t-e}));var i=0,s=n.below.length&&n.below[i].index,l=0;if(n.below.length)for(var a=0;a<o.length;a++){var c=o[a];if(a===s){var h={height:r[s],offsetTop:c.offsetTop+l,value:n.below[i].value};o.splice(a,0,h),l+=r[s],i+=1,s=n.below[i]&&n.below[i].index}else c.offsetTop+=l}for(;0!==n.above.length;){var f=n.above.pop();h={height:r[f.index],offsetTop:o[o.length-1].offsetTop+r[f.index],value:f.value};o.push(h)}},t.prototype.processItemMetaForUpdate=function(t,e,o){var r={};e=e.slice(e.length-t.length),t.forEach((function(t,o){r[t.index]=e[o].getBoundingClientRect().height}));for(var n=0,i=t[n].index,s=0,l=0;l<o.length;l++){var a=o[l];if(l===i){a.offsetTop+=s,a.value=t[n].value;var c=r[i];s+=c-a.height,a.height=c,i=t[++n]&&t[n].index}else a.offsetTop+=s}},t.prototype.processItemMetaForRemove=function(t,e){for(var o=0,r=t[o]&&t[o].index,n=0,i=0,s=e[i];i<e.length;s=e[++i])i===r?(n+=s.height,e.splice(i,1),t=this.updateIndexes(i,t),i--,r=t[++o]&&t[o].index):s.offsetTop-=n},t.prototype.updateIndexes=function(t,e){return e.map((function(e){return e.index>t&&(e.index-=1),e}))},t.prototype.getItemDifference=function(t,e){var o=this,r=t.map((function(t){return t[o.trackBy]})),n=[];return e.forEach((function(t,e){r.includes(t[o.trackBy])||n.push({value:t,index:e})})),n},t.prototype.getItemDifferenceForEqualLength=function(t,e){var o=this,r=t.map((function(t){return t[o.trackBy]})),n=[];return e.forEach((function(e,i){if(r.includes(e[o.trackBy])){var s=t.findIndex((function(t){return t[o.trackBy]===e[o.trackBy]}));-1!==s&&t[s]!==e&&n.push({value:e,index:i})}else n.push({value:e,index:i})})),n},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[]},t.ngInjectableDef=e.ɵɵdefineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}();var s=function(){function t(t){this.scrollerService=t,this.viewportItems=new e.EventEmitter,this.scrollEnd=new e.EventEmitter,this.setDefaults()}return Object.defineProperty(t.prototype,"scrollParentDiv",{get:function(){return this.scrollParentElementRef&&this.scrollParentElementRef.nativeElement},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scrollItemsDiv",{get:function(){return this.scrollItemsElementRef&&this.scrollItemsElementRef.nativeElement},enumerable:!0,configurable:!0}),t.prototype.ngOnInit=function(){if(!this.trackBy)throw new Error("ItemKey must be set to determine the changes and calculations of scroll offsets");this.scrollerService.trackBy=this.trackBy},t.prototype.ngOnChanges=function(t){var e=t.items;if(e)if(e.firstChange||0===e.previousValue.length)this.initialRender();else{var o=this.scrollerService.onItemChange(e.previousValue,e.currentValue);this.handleItemChange(o)}},t.prototype.scrollTo=function(t){var e=t.offsetTop||this.itemMeta[t.index].offsetTop;this.scrollParentDiv.scrollTo({top:e})},t.prototype.getItemIndex=function(t){return this.lastStartIndex+t},t.prototype.setDefaults=function(){this.clonedViewportItems=[],this.itemMeta=[],this.maxYOffset=0,this.scrollHeight=0,this.buffer=10,this.lastStartIndex=0,this.lastCount=this.buffer,this.mutationObservers=[]},t.prototype.initialRender=function(){var t=this;this.setViewportItems(this.items),setTimeout((function(){t.processItemMeta(),t.setScrollHeight(),t.setViewportItems(t.items.slice(0,t.buffer)),setTimeout((function(){t.attachMutationObservers()}))}))},t.prototype.setViewportItems=function(t){this.clonedViewportItems=Array.from(t),this.viewportItems.emit(t)},t.prototype.processItemMeta=function(){var t=this;this.getHtmlElements().forEach((function(e,o){t.itemMeta.push({offsetTop:e.offsetTop,height:e.getBoundingClientRect().height,value:t.items[o]})}))},t.prototype.getHtmlElements=function(){var t=this.scrollItemsDiv.childNodes;return Array.from(t).filter((function(t){return 1===t.nodeType}))},t.prototype.setScrollHeight=function(){var t=this.itemMeta[this.itemMeta.length-1];this.maxYOffset=t.offsetTop,this.scrollHeight=this.maxYOffset+t.height},t.prototype.onScroll=function(){var t=this;clearTimeout(this.isScrolling),clearTimeout(this.isScrollingEvent),this.isScrolling=setTimeout((function(){t.handleScroll()}),15),this.isScrollingEvent=setTimeout((function(){t.scrollEnd.emit()}),200)},t.prototype.handleScroll=function(){var t=this,e=this.scrollParentDiv.scrollTop;if(e>=this.maxYOffset)this.updateOffsetYPosition(this.maxYOffset);else{var o=this.scrollerService.getClosestItemIndex(e,this.itemMeta),r=this.scrollerService.getViewportMeta(o,this.buffer,this.itemMeta);if(r.startIndex!==this.lastStartIndex||r.count!==this.lastCount){this.lastStartIndex=r.startIndex,this.lastCount=r.count,this.deattachMutationObserver();var n=this.items.slice(r.startIndex,r.count);this.setViewportItems(n);var i=0===Math.max(0,o-this.buffer)?0:this.itemMeta[r.startIndex].offsetTop;this.updateOffsetYPosition(i),setTimeout((function(){t.attachMutationObservers()}))}}},t.prototype.handleItemChange=function(t){switch(t.operation){case n.ADD:this.handleAddChange(t);break;case n.UPDATE:this.handleUpdateChange(t);break;case n.REMOVE:this.handleRemoveChange(t)}},t.prototype.handleAddChange=function(t){var e,o=this,n=this.scrollParentDiv.scrollTop,i=t.diff.map((function(t){return t.value}));(e=this.clonedViewportItems).push.apply(e,r(i)),this.setViewportItems(this.clonedViewportItems),setTimeout((function(){var e=o.getHtmlElements();o.scrollerService.processItemMetaForAdd(t.diff,e,o.itemMeta);var r=o.items.slice(o.lastStartIndex,o.lastCount);o.setViewportItems(r),o.setScrollHeight(),setTimeout((function(){o.scrollParentDiv.scrollTo({top:n})}))}))},t.prototype.handleUpdateChange=function(t){var e,o=this,n=this.scrollParentDiv.scrollTop,i=t.diff.filter((function(t){return!(t.index<=o.lastCount&&t.index>=o.lastStartIndex)}));if(i.length)(e=this.clonedViewportItems).push.apply(e,r(i.map((function(t){return t.value})))),this.setViewportItems(this.clonedViewportItems),setTimeout((function(){var t=o.getHtmlElements();o.scrollerService.processItemMetaForUpdate(i,t,o.itemMeta);var e=o.items.slice(o.lastStartIndex,o.lastCount);o.setViewportItems(e),o.setScrollHeight(),setTimeout((function(){o.scrollParentDiv.scrollTo({top:n})}))}));else{var s=t.diff.filter((function(t){return t.index<=o.lastCount&&t.index>=o.lastStartIndex})),l=this.items.slice(this.lastStartIndex,this.lastCount);this.setViewportItems(l),setTimeout((function(){var t=o.getHtmlElements();o.scrollerService.processItemMetaForUpdate(s,t,o.itemMeta),o.setScrollHeight(),setTimeout((function(){o.scrollParentDiv.scrollTo({top:n})}))}))}},t.prototype.handleRemoveChange=function(t){var e=this,o=this.scrollParentDiv.scrollTop;this.scrollerService.processItemMetaForRemove(t.diff,this.itemMeta);var r=this.items.slice(this.lastStartIndex,this.lastCount);this.setViewportItems(r),this.setScrollHeight(),setTimeout((function(){e.scrollParentDiv.scrollTo({top:o})}))},t.prototype.updateOffsetYPosition=function(t){this.scrollItemsDiv.style.transform="translateY("+t+"px)"},t.prototype.attachMutationObservers=function(){var t=this;this.getHtmlElements().forEach((function(e,o){var r=t.getItemIndex(o),n=new MutationObserver((function(){return t.onObserve(e,r)}));n.observe(e,{subtree:!0,childList:!0}),t.mutationObservers.push(n)}))},t.prototype.onObserve=function(t,e){var o=t.getBoundingClientRect().height;if(o!==this.itemMeta[e].height){var r=o-this.itemMeta[e].height;this.itemMeta[e].height=o;for(var n=e+1;n<this.itemMeta.length;n++){this.itemMeta[n].offsetTop+=r}this.setScrollHeight()}},t.prototype.deattachMutationObserver=function(){this.mutationObservers.forEach((function(t){t.disconnect()})),this.mutationObservers=[]},t.decorators=[{type:e.Component,args:[{selector:"ngx-vscroll",template:'<div #scrollParent class="scroll-parent" (scroll)="onScroll();">\n  <div #scrollItems class="scroll-items">\n    <ng-content></ng-content>\n  </div>\n  <div class="scroll-size" [style.height.px]="scrollHeight"></div>\n</div>\n',encapsulation:e.ViewEncapsulation.None,styles:[".vscroll-scroll-parent{height:100%;overflow:auto;position:relative;scroll-behavior:smooth}.vscroll-scroll-items{position:relative}.vscroll-scroll-size{position:absolute;top:0;left:0;width:100%;opacity:0;z-index:-1}ngx-vscroll{display:block}"]}]}],t.ctorParameters=function(){return[{type:i}]},t.propDecorators={viewportItems:[{type:e.Output}],scrollEnd:[{type:e.Output}],items:[{type:e.Input}],buffer:[{type:e.Input}],trackBy:[{type:e.Input}],scrollParentElementRef:[{type:e.ViewChild,args:["scrollParent",{static:!1}]}],scrollItemsElementRef:[{type:e.ViewChild,args:["scrollItems",{static:!1}]}]},t}();var l=function(){function t(){}return t.decorators=[{type:e.NgModule,args:[{declarations:[s],imports:[],exports:[s]}]}],t}();t.NgxVScrollComponent=s,t.NgxVScrollModule=l,t.NgxVScrollService=i,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=ngx-vscroll.umd.min.js.map